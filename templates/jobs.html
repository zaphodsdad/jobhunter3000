<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jobs — JobHunter3000</title>
  <style>
  {% include 'base_styles.html' %}
    /* ── Filter Bar ─────────────────────────────────────── */
    .filter-bar {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: #0c0e14;
      border: 1px solid #1a1f2e;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .filter-bar label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
      margin-right: 0.25rem;
    }

    .filter-bar select {
      background: #111318;
      color: #e2e8f0;
      border: 1px solid #2a2f3e;
      border-radius: 6px;
      padding: 0.4rem 0.6rem;
      font-size: 0.85rem;
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s;
    }

    .filter-bar select:hover,
    .filter-bar select:focus {
      border-color: #00e5ff;
    }

    .filter-count {
      margin-left: auto;
      font-size: 0.85rem;
      color: #6b7280;
    }

    .filter-count strong {
      color: #e2e8f0;
    }

    /* ── Text Size Toggle ─────────────────────────────── */
    .size-toggle {
      display: inline-flex;
      gap: 2px;
      border: 1px solid #2a2f3e;
      border-radius: 6px;
      overflow: hidden;
    }

    .size-toggle button {
      background: #111318;
      color: #6b7280;
      border: none;
      padding: 0.3rem 0.5rem;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.15s;
      line-height: 1;
    }

    .size-toggle button:hover {
      color: #e2e8f0;
    }

    .size-toggle button.active {
      background: rgba(0, 229, 255, 0.12);
      color: #00e5ff;
    }

    .size-toggle .size-sm { font-size: 0.7rem; }
    .size-toggle .size-md { font-size: 0.85rem; }
    .size-toggle .size-lg { font-size: 1.05rem; }

    /* Table size classes */
    .jobs-table.text-sm { font-size: 0.82rem; }
    .jobs-table.text-md { font-size: 0.95rem; }
    .jobs-table.text-lg { font-size: 1.1rem; }

    .jobs-table.text-md tbody tr.job-row td { padding: 0.7rem 0.75rem; }
    .jobs-table.text-lg tbody tr.job-row td { padding: 0.85rem 0.75rem; }

    /* ── Jobs Table ─────────────────────────────────────── */
    .jobs-table-wrap {
      overflow-x: auto;
    }

    .jobs-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .jobs-table thead th {
      text-align: left;
      padding: 0.65rem 0.75rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
      border-bottom: 1px solid #1a1f2e;
      white-space: nowrap;
      user-select: none;
    }

    .jobs-table thead th.sortable {
      cursor: pointer;
      transition: color 0.15s;
    }

    .jobs-table thead th.sortable:hover {
      color: #00e5ff;
    }

    .jobs-table thead th.sorted {
      color: #00e5ff;
    }

    .sort-arrow {
      font-size: 0.65rem;
      margin-left: 4px;
      opacity: 0.5;
    }

    .sorted .sort-arrow {
      opacity: 1;
    }

    .jobs-table tbody tr.job-row {
      cursor: pointer;
      transition: background 0.15s;
    }

    .jobs-table tbody tr.job-row:hover {
      background: rgba(0, 229, 255, 0.04);
    }

    .jobs-table tbody tr.job-row td {
      padding: 0.6rem 0.75rem;
      border-bottom: 1px solid #111318;
      vertical-align: middle;
    }

    /* ── Score Badge ────────────────────────────────────── */
    .score-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 2.4rem;
      padding: 0.2rem 0.5rem;
      border-radius: 6px;
      font-weight: 700;
      font-size: 0.85rem;
      text-align: center;
    }

    .score-badge.score-high {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .score-badge.score-good {
      background: rgba(0, 229, 255, 0.12);
      color: #00e5ff;
      border: 1px solid rgba(0, 229, 255, 0.25);
    }

    .score-badge.score-mid {
      background: rgba(245, 158, 11, 0.12);
      color: #fbbf24;
      border: 1px solid rgba(245, 158, 11, 0.25);
    }

    .score-badge.score-low {
      background: rgba(107, 114, 128, 0.12);
      color: #6b7280;
      border: 1px solid rgba(107, 114, 128, 0.25);
    }

    /* ── Status Badge ──────────────────────────────────── */
    .status-badge {
      display: inline-block;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: capitalize;
      white-space: nowrap;
    }

    .status-badge.status-new          { background: rgba(99, 102, 241, 0.15); color: #818cf8; }
    .status-badge.status-interested   { background: rgba(0, 229, 255, 0.12);  color: #00e5ff; }
    .status-badge.status-applied      { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
    .status-badge.status-interviewing { background: rgba(16, 185, 129, 0.15); color: #34d399; }
    .status-badge.status-offer        { background: rgba(168, 85, 247, 0.15); color: #c084fc; }
    .status-badge.status-rejected     { background: rgba(239, 68, 68, 0.12);  color: #f87171; }
    .status-badge.status-archived     { background: rgba(107, 114, 128, 0.12); color: #6b7280; }
    .status-badge.status-accepted     { background: rgba(16, 185, 129, 0.2);  color: #34d399; }

    /* ── Inline Status Select ────────────────────────────── */
    .status-select {
      background: #111318;
      color: #e2e8f0;
      border: 1px solid #2a2f3e;
      border-radius: 6px;
      padding: 0.25rem 0.4rem;
      font-size: 0.78rem;
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s;
    }

    .status-select:hover,
    .status-select:focus {
      border-color: #00e5ff;
    }

    /* ── Column Styling ────────────────────────────────── */
    .job-title-cell {
      font-weight: 600;
      color: #e2e8f0;
    }

    .job-company-cell {
      color: #94a3b8;
    }

    .job-location-cell {
      color: #6b7280;
      font-size: 0.82rem;
    }

    .job-date-cell {
      color: #6b7280;
      font-size: 0.82rem;
      white-space: nowrap;
    }

    /* ── Quick Search Bar ────────────────────────────────── */
    .quick-search-bar {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: #0c0e14;
      border: 1px solid #1a1f2e;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .quick-search-bar label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
      margin-right: 0.25rem;
    }

    .quick-search-bar input[type="text"] {
      background: #111318;
      color: #e2e8f0;
      border: 1px solid #2a2f3e;
      border-radius: 6px;
      padding: 0.4rem 0.6rem;
      font-size: 0.85rem;
      outline: none;
      transition: border-color 0.2s;
    }

    .quick-search-bar input[type="text"]:focus {
      border-color: #00e5ff;
    }

    .quick-search-bar input[type="text"]::placeholder {
      color: #4b5563;
    }

    .quick-search-bar .qs-query { width: 220px; }
    .quick-search-bar .qs-location { width: 180px; }

    .quick-search-bar button {
      background: rgba(0, 229, 255, 0.12);
      color: #00e5ff;
      border: 1px solid rgba(0, 229, 255, 0.25);
      border-radius: 6px;
      padding: 0.4rem 1rem;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-search-bar button:hover {
      background: rgba(0, 229, 255, 0.2);
      border-color: #00e5ff;
    }

    .quick-search-bar button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .quick-search-bar .qs-status {
      font-size: 0.82rem;
      color: #6b7280;
    }

    .quick-search-bar .qs-status.running {
      color: #fbbf24;
    }

    .quick-search-bar .qs-status.done {
      color: #34d399;
    }

    .quick-search-bar .qs-status.error {
      color: #f87171;
    }

    /* ── Ghost Risk Badge ────────────────────────────────── */
    .ghost-badge {
      display: inline-block;
      padding: 0.1rem 0.45rem;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      vertical-align: middle;
      margin-left: 6px;
    }
    .ghost-badge.ghost-high { background: rgba(239, 68, 68, 0.15); color: #f87171; }
    .ghost-badge.ghost-medium { background: rgba(245, 158, 11, 0.12); color: #fbbf24; }

    /* ── Job Summary ──────────────────────────────────── */
    .job-summary-text {
      font-size: 0.78rem;
      color: #6b7280;
      margin-top: 2px;
      line-height: 1.4;
      max-width: 500px;
    }

    /* ── Favorite Star ─────────────────────────────────── */
    .fav-star {
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      margin-right: 6px;
      vertical-align: middle;
      transition: color 0.15s, transform 0.15s;
    }

    .fav-star:hover {
      transform: scale(1.2);
    }

    .fav-star.active {
      color: #fbbf24;
    }

    .fav-star.inactive {
      color: #4b5563;
    }

    .job-row.favorited {
      border-left: 3px solid #fbbf24;
    }

    .fav-filter-btn {
      background: #111318;
      color: #4b5563;
      border: 1px solid #2a2f3e;
      border-radius: 6px;
      padding: 0.3rem 0.55rem;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      transition: all 0.15s;
    }

    .fav-filter-btn:hover {
      border-color: #fbbf24;
      color: #fbbf24;
    }

    .fav-filter-btn.active {
      background: rgba(251, 191, 36, 0.12);
      color: #fbbf24;
      border-color: rgba(251, 191, 36, 0.4);
    }

    /* ── Empty State ───────────────────────────────────── */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6b7280;
    }

    .empty-state h3 {
      color: #94a3b8;
      margin-bottom: 0.5rem;
    }

  </style>
</head>
<body>

  <!-- ── Topbar ──────────────────────────────────────── -->
  <header class="topbar">
    <div class="topbar-brand">Job<span>Hunter</span>3000</div>
    <div class="topbar-right">Intel Report</div>
  </header>

  <!-- ── Navigation ──────────────────────────────────── -->
  {% set active = 'jobs' %}
  {% include 'nav.html' %}

  <!-- ── Content ─────────────────────────────────────── -->
  <main class="content">

    <!-- Filter Bar -->
    <div class="filter-bar">
      <label for="filter-status">Status</label>
      <select id="filter-status" onchange="applyFilters()">
        <option value="">All Statuses</option>
        {% for s in statuses %}
        <option value="{{ s }}" {% if current_status == s %}selected{% endif %}>{{ s | capitalize }}</option>
        {% endfor %}
      </select>

      <label for="filter-source">Source</label>
      <select id="filter-source" onchange="applyFilters()">
        <option value="">All Sources</option>
        {% for src in sources %}
        <option value="{{ src }}" {% if current_source == src %}selected{% endif %}>{{ src | capitalize }}</option>
        {% endfor %}
      </select>

      <label for="filter-campaign">Campaign</label>
      <select id="filter-campaign" onchange="applyFilters()">
        <option value="">All Campaigns</option>
        {% for sq in search_queries %}
        <option value="{{ sq }}" {% if current_search_query == sq %}selected{% endif %}>{{ sq }}</option>
        {% endfor %}
      </select>

      <label for="filter-freshness">Posted</label>
      <select id="filter-freshness" onchange="applyFilters()">
        <option value="0" {% if current_freshness == 0 %}selected{% endif %}>Any Time</option>
        <option value="24" {% if current_freshness == 24 %}selected{% endif %}>Last 24h</option>
        <option value="48" {% if current_freshness == 48 %}selected{% endif %}>Last 48h</option>
        <option value="168" {% if current_freshness == 168 %}selected{% endif %}>Last 7 days</option>
      </select>

      <label for="filter-min-score">Min Score</label>
      <select id="filter-min-score" onchange="applyFilters()">
        <option value="0" {% if current_min_score == 0 %}selected{% endif %}>All Scores</option>
        <option value="30" {% if current_min_score == 30 %}selected{% endif %}>30+</option>
        <option value="40" {% if current_min_score == 40 %}selected{% endif %}>40+</option>
        <option value="50" {% if current_min_score == 50 %}selected{% endif %}>50+</option>
        <option value="60" {% if current_min_score == 60 %}selected{% endif %}>60+</option>
        <option value="70" {% if current_min_score == 70 %}selected{% endif %}>70+</option>
        <option value="80" {% if current_min_score == 80 %}selected{% endif %}>80+</option>
      </select>

      <label for="filter-sort">Sort</label>
      <select id="filter-sort" onchange="applyFilters()">
        <option value="score_desc" {% if current_sort == 'score' and current_order == 'desc' %}selected{% endif %}>Score (High &rarr; Low)</option>
        <option value="score_asc" {% if current_sort == 'score' and current_order == 'asc' %}selected{% endif %}>Score (Low &rarr; High)</option>
        <option value="is_favorite_desc" {% if current_sort == 'is_favorite' and current_order == 'desc' %}selected{% endif %}>Favorites First</option>
        <option value="created_at_desc" {% if current_sort == 'created_at' and current_order == 'desc' %}selected{% endif %}>Date (Newest)</option>
        <option value="created_at_asc" {% if current_sort == 'created_at' and current_order == 'asc' %}selected{% endif %}>Date (Oldest)</option>
        <option value="company_asc" {% if current_sort == 'company' and current_order == 'asc' %}selected{% endif %}>Company (A &rarr; Z)</option>
        <option value="title_asc" {% if current_sort == 'title' and current_order == 'asc' %}selected{% endif %}>Title (A &rarr; Z)</option>
      </select>

      <button class="fav-filter-btn {% if current_favorites %}active{% endif %}" id="favFilterBtn" onclick="toggleFavFilter()" title="Show favorites only">
        {% if current_favorites %}&#9733;{% else %}&#9734;{% endif %}
      </button>

      <label>Size</label>
      <div class="size-toggle">
        <button class="size-sm" onclick="setTextSize('sm')" title="Small">A</button>
        <button class="size-md" onclick="setTextSize('md')" title="Medium">A</button>
        <button class="size-lg" onclick="setTextSize('lg')" title="Large">A</button>
      </div>

      <span class="filter-count">Showing <strong>{{ jobs | length }}</strong> job{{ 's' if jobs | length != 1 else '' }}</span>
    </div>

    <!-- Quick Search -->
    <div class="quick-search-bar">
      <label>Quick Search</label>
      <input type="text" id="qs-query" class="qs-query" placeholder="e.g. IT Support, Facility Manager">
      <label>Location</label>
      <input type="text" id="qs-location" class="qs-location" placeholder="e.g. Oklahoma City, OK">
      <button id="qs-btn" onclick="runQuickSearch()">Search</button>
      <span id="qs-status" class="qs-status"></span>
    </div>

    <!-- Jobs Table -->
    {% if jobs | length > 0 %}
    <div class="jobs-table-wrap">
      <table class="jobs-table">
        <thead>
          <tr>
            <th class="sortable {% if current_sort == 'score' %}sorted{% endif %}" onclick="sortBy('score')">
              Score <span class="sort-arrow">{% if current_sort == 'score' %}{{ '&#9650;' if current_order == 'asc' else '&#9660;' }}{% else %}&#9660;{% endif %}</span>
            </th>
            <th class="sortable {% if current_sort == 'title' %}sorted{% endif %}" onclick="sortBy('title')">
              Title <span class="sort-arrow">{% if current_sort == 'title' %}{{ '&#9650;' if current_order == 'asc' else '&#9660;' }}{% else %}&#9650;{% endif %}</span>
            </th>
            <th class="sortable {% if current_sort == 'company' %}sorted{% endif %}" onclick="sortBy('company')">
              Company <span class="sort-arrow">{% if current_sort == 'company' %}{{ '&#9650;' if current_order == 'asc' else '&#9660;' }}{% else %}&#9650;{% endif %}</span>
            </th>
            <th class="sortable {% if current_sort == 'location' %}sorted{% endif %}" onclick="sortBy('location')">
              Location <span class="sort-arrow">{% if current_sort == 'location' %}{{ '&#9650;' if current_order == 'asc' else '&#9660;' }}{% else %}&#9650;{% endif %}</span>
            </th>
            <th class="sortable {% if current_sort == 'status' %}sorted{% endif %}" onclick="sortBy('status')">
              Status <span class="sort-arrow">{% if current_sort == 'status' %}{{ '&#9650;' if current_order == 'asc' else '&#9660;' }}{% else %}&#9650;{% endif %}</span>
            </th>
            <th class="sortable {% if current_sort == 'created_at' %}sorted{% endif %}" onclick="sortBy('created_at')">
              Date <span class="sort-arrow">{% if current_sort == 'created_at' %}{{ '&#9650;' if current_order == 'asc' else '&#9660;' }}{% else %}&#9660;{% endif %}</span>
            </th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for job in jobs %}
          <tr class="job-row {% if job.is_favorite %}favorited{% endif %}" id="row-{{ job.id }}" onclick="openJob({{ job.id }}, event)">
            <td>
              <span class="fav-star {% if job.is_favorite %}active{% else %}inactive{% endif %}" data-job-id="{{ job.id }}" onclick="toggleFavorite({{ job.id }}, event)">{% if job.is_favorite %}&#9733;{% else %}&#9734;{% endif %}</span>
              {% if job.score is not none %}
              <span class="score-badge {% if job.score >= 80 %}score-high{% elif job.score >= 60 %}score-good{% elif job.score >= 40 %}score-mid{% else %}score-low{% endif %}">
                {{ job.score }}
              </span>
              {% else %}
              <span class="score-badge score-low">&mdash;</span>
              {% endif %}
            </td>
            <td class="job-title-cell">
              {{ job.title }}
              {% if job.ghost_risk == 'high' %}<span class="ghost-badge ghost-high" title="Possibly a ghost/fake listing">Ghost?</span>
              {% elif job.ghost_risk == 'medium' %}<span class="ghost-badge ghost-medium" title="Some vague elements in listing">Vague</span>{% endif %}
              {% if job.summary %}<div class="job-summary-text">{{ job.summary }}</div>{% endif %}
            </td>
            <td class="job-company-cell">{{ job.company or '—' }}{% if not job.salary_text and job.salary_estimate %}<div style="font-size:0.72rem;color:#fbbf24;margin-top:1px;" title="AI-estimated salary">{{ job.salary_estimate }} (est.)</div>{% elif job.salary_text %}<div style="font-size:0.72rem;color:#6b7280;margin-top:1px;">{{ job.salary_text }}</div>{% endif %}</td>
            <td class="job-location-cell">{{ job.location or '—' }}</td>
            <td>
              <span class="status-badge status-{{ job.status or 'new' }}">{{ (job.status or 'new') | capitalize }}</span>
            </td>
            <td class="job-date-cell">
              {% if job.created_at %}
                {{ job.created_at[:10] }}
              {% else %}
                &mdash;
              {% endif %}
            </td>
            <td onclick="event.stopPropagation()">
              <select class="status-select" data-job-id="{{ job.id }}" onchange="changeStatus(this)">
                <option value="new" {% if (job.status or 'new') == 'new' %}selected{% endif %}>New</option>
                <option value="interested" {% if job.status == 'interested' %}selected{% endif %}>Interested</option>
                <option value="applied" {% if job.status == 'applied' %}selected{% endif %}>Applied</option>
                <option value="interviewing" {% if job.status == 'interviewing' %}selected{% endif %}>Interviewing</option>
                <option value="offer" {% if job.status == 'offer' %}selected{% endif %}>Offer</option>
                <option value="accepted" {% if job.status == 'accepted' %}selected{% endif %}>Accepted</option>
                <option value="rejected" {% if job.status == 'rejected' %}selected{% endif %}>Rejected</option>
                <option value="archived" {% if job.status == 'archived' %}selected{% endif %}>Archived</option>
              </select>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">
      <h3>No jobs found</h3>
      <p>Adjust your filters or run a scrape to populate the database.</p>
    </div>
    {% endif %}

  </main>


  <script>
    var currentSort = {{ current_sort | tojson }};
    var currentOrder = {{ current_order | tojson }};

    /* ── Text Size ──────────────────────────────────────── */
    function setTextSize(size) {
      var table = document.querySelector('.jobs-table');
      if (!table) return;
      table.classList.remove('text-sm', 'text-md', 'text-lg');
      table.classList.add('text-' + size);
      document.querySelectorAll('.size-toggle button').forEach(function(btn) {
        btn.classList.toggle('active', btn.classList.contains('size-' + size));
      });
      localStorage.setItem('jh3k-text-size', size);
    }
    // Restore saved size on load
    (function() {
      var saved = localStorage.getItem('jh3k-text-size') || 'sm';
      setTextSize(saved);
    })();

    /* ── Navigate to job detail page ───────────────────── */
    function openJob(jobId, event) {
      if (event && (event.target.tagName === 'SELECT' || event.target.tagName === 'OPTION')) return;
      window.location.href = '/jobs/' + jobId;
    }

    /* ── Filter Navigation ─────────────────────────────── */
    function applyFilters() {
      var status = document.getElementById('filter-status').value;
      var source = document.getElementById('filter-source').value;
      var campaign = document.getElementById('filter-campaign').value;
      var freshness = document.getElementById('filter-freshness').value;
      var minScore = document.getElementById('filter-min-score').value;
      var sortVal = document.getElementById('filter-sort').value;
      var lastUnderscore = sortVal.lastIndexOf('_');
      var sort = sortVal.substring(0, lastUnderscore);
      var order = sortVal.substring(lastUnderscore + 1);
      var params = new URLSearchParams();
      if (status) params.set('status', status);
      if (source) params.set('source', source);
      if (campaign) params.set('search_query', campaign);
      if (freshness && freshness !== '0') params.set('freshness', freshness);
      if (minScore && minScore !== '0') params.set('min_score', minScore);
      if (sort) params.set('sort', sort);
      if (order) params.set('order', order);
      var curParams = new URLSearchParams(window.location.search);
      if (curParams.get('favorites') === '1') params.set('favorites', '1');
      window.location.href = '/jobs' + (params.toString() ? '?' + params.toString() : '');
    }

    /* ── Clickable column sort ─────────────────────────── */
    function sortBy(column) {
      var status = document.getElementById('filter-status').value;
      var source = document.getElementById('filter-source').value;
      var campaign = document.getElementById('filter-campaign').value;
      var freshness = document.getElementById('filter-freshness').value;
      var minScore = document.getElementById('filter-min-score').value;
      var defaults = { score: 'desc', title: 'asc', company: 'asc', location: 'asc', status: 'asc', created_at: 'desc' };
      var order = defaults[column] || 'desc';
      if (currentSort === column) order = currentOrder === 'desc' ? 'asc' : 'desc';
      var params = new URLSearchParams();
      if (status) params.set('status', status);
      if (source) params.set('source', source);
      if (campaign) params.set('search_query', campaign);
      if (freshness && freshness !== '0') params.set('freshness', freshness);
      if (minScore && minScore !== '0') params.set('min_score', minScore);
      params.set('sort', column);
      params.set('order', order);
      var curParams = new URLSearchParams(window.location.search);
      if (curParams.get('favorites') === '1') params.set('favorites', '1');
      window.location.href = '/jobs?' + params.toString();
    }

    function updateJobCount() {
      var count = document.querySelectorAll('tr.job-row').length;
      var el = document.querySelector('.filter-count strong');
      if (el) el.textContent = count;
    }

    /* ── Quick Search ──────────────────────────────────── */
    function runQuickSearch() {
      var query = document.getElementById('qs-query').value.trim();
      var location = document.getElementById('qs-location').value.trim();
      var btn = document.getElementById('qs-btn');
      var statusEl = document.getElementById('qs-status');

      if (!query) {
        statusEl.className = 'qs-status error';
        statusEl.textContent = 'Enter a search query';
        return;
      }

      btn.disabled = true;
      statusEl.className = 'qs-status running';
      statusEl.textContent = 'Searching (this may take a minute)...';

      fetch('/api/scraper/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: query, location: location })
      })
      .then(function(resp) { return resp.json(); })
      .then(function(data) {
        if (data.error) {
          statusEl.className = 'qs-status error';
          statusEl.textContent = data.error;
          btn.disabled = false;
          return;
        }
        statusEl.className = 'qs-status done';
        statusEl.textContent = 'Found ' + data.jobs_found + ' jobs (' + data.jobs_new + ' new, ' + data.scored + ' scored). Reloading...';
        setTimeout(function() {
          window.location.href = '/jobs?search_query=' + encodeURIComponent(query);
        }, 1000);
      })
      .catch(function(err) {
        statusEl.className = 'qs-status error';
        statusEl.textContent = 'Search failed: ' + err.message;
        btn.disabled = false;
      });
    }

    // Allow Enter key in quick search inputs
    document.getElementById('qs-query').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') runQuickSearch();
    });
    document.getElementById('qs-location').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') runQuickSearch();
    });

    /* ── Favorite Toggle ──────────────────────────────── */
    function toggleFavorite(jobId, event) {
      event.stopPropagation();
      fetch('/api/jobs/' + jobId + '/favorite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(function(resp) { return resp.json(); })
      .then(function(data) {
        if (!data.ok) return;
        var star = document.querySelector('.fav-star[data-job-id="' + jobId + '"]');
        var row = document.getElementById('row-' + jobId);
        if (data.is_favorite) {
          star.innerHTML = '&#9733;';
          star.classList.remove('inactive');
          star.classList.add('active');
          if (row) row.classList.add('favorited');
        } else {
          star.innerHTML = '&#9734;';
          star.classList.remove('active');
          star.classList.add('inactive');
          if (row) row.classList.remove('favorited');
        }
      });
    }

    /* ── Favorites Filter ──────────────────────────────── */
    function toggleFavFilter() {
      var params = new URLSearchParams(window.location.search);
      if (params.get('favorites') === '1') {
        params.delete('favorites');
      } else {
        params.set('favorites', '1');
      }
      window.location.href = '/jobs' + (params.toString() ? '?' + params.toString() : '');
    }

    /* ── Inline Status Change (table) ──────────────────── */
    function changeStatus(selectEl) {
      var jobId = selectEl.getAttribute('data-job-id');
      var newStatus = selectEl.value;
      fetch('/api/jobs/' + jobId + '/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      })
      .then(function(resp) {
        if (!resp.ok) throw new Error('Status update failed');
        return resp.json();
      })
      .then(function() {
        var row = selectEl.closest('tr.job-row');
        if (row) {
          var badge = row.querySelector('.status-badge');
          if (badge) {
            badge.className = 'status-badge status-' + newStatus;
            badge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
          }
          row.style.transition = 'background 0.3s';
          row.style.background = 'rgba(74, 222, 128, 0.08)';
          setTimeout(function() { row.style.background = ''; }, 800);
          if (newStatus === 'archived') {
            setTimeout(function() {
              row.style.transition = 'opacity 0.5s';
              row.style.opacity = '0';
              setTimeout(function() { row.remove(); updateJobCount(); }, 500);
            }, 800);
          } else if (newStatus === 'rejected') {
            setTimeout(function() { row.style.transition = 'opacity 0.5s'; row.style.opacity = '0.3'; }, 1000);
          }
        }
      })
      .catch(function() {
        var row = selectEl.closest('tr.job-row');
        if (row) {
          row.style.transition = 'background 0.3s';
          row.style.background = 'rgba(239, 68, 68, 0.1)';
          setTimeout(function() { row.style.background = ''; }, 1500);
        }
      });
    }
  </script>

</body>
</html>
