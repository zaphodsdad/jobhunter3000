<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobHunter3000 — Analytics</title>
    <style>
        {% include 'base_styles.html' %}

        /* ── Analytics-specific styles ──────────────────────────── */

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: var(--surface, #0d1117);
            border-bottom: 1px solid var(--border, #21262d);
        }

        .topbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary, #e6edf3);
            letter-spacing: -0.5px;
        }

        .topbar-brand span {
            color: var(--cyan, #00e5ff);
        }

        .content-area {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem 2rem 3rem;
        }

        .page-header {
            margin-bottom: 1.5rem;
        }

        .page-header h1 {
            color: var(--text-primary, #e6edf3);
            font-weight: 600;
            margin: 0 0 0.25rem 0;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-size: 0.85rem;
        }

        .page-header h1::before {
            content: '//';
            color: var(--accent-primary, #22d3ee);
            margin-right: 0.5rem;
        }

        .page-header p {
            font-size: 0.8rem;
            color: var(--text-muted, #8b949e);
            margin: 0;
        }

        /* ── KPI Cards ──────────────────────────────────────────── */

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: var(--bg-card, #1a1d27);
            border: 1px solid var(--border, #2a2d3a);
            border-radius: 8px;
            padding: 1.25rem;
            border-left: 3px solid var(--border, #2a2d3a);
        }

        .kpi-card__label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--text-muted, #666);
            margin-bottom: 0.5rem;
        }

        .kpi-card__value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary, #e0e0e0);
            line-height: 1;
            margin-bottom: 0.35rem;
        }

        .kpi-card__sub {
            font-size: 0.75rem;
            color: var(--text-muted, #666);
        }

        .kpi--total { border-left-color: var(--accent-primary, #22d3ee); }
        .kpi--applied { border-left-color: #a78bfa; }
        .kpi--response { border-left-color: #4ade80; }
        .kpi--avgscore { border-left-color: #fbbf24; }

        .kpi-val--green { color: #4ade80; }
        .kpi-val--amber { color: #fbbf24; }
        .kpi-val--red { color: #f87171; }

        /* ── Chart Panels ───────────────────────────────────────── */

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-panel {
            background: var(--bg-card, #1a1d27);
            border: 1px solid var(--border, #2a2d3a);
            border-radius: 8px;
            padding: 1.25rem;
        }

        .chart-panel__title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--text-muted, #666);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border, #2a2d3a);
        }

        .chart-panel canvas {
            max-height: 280px;
        }

        .chart-panel--full {
            grid-column: 1 / -1;
        }

        /* ── Source Table ────────────────────────────────────────── */

        .source-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .source-table thead th {
            background: var(--bg-nav, #13151d);
            color: var(--text-muted, #666);
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.65rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border, #2a2d3a);
        }

        .source-table thead th:last-child,
        .source-table thead th:nth-child(n+2) {
            text-align: right;
        }

        .source-table tbody tr {
            border-bottom: 1px solid var(--border, #2a2d3a);
        }

        .source-table tbody tr:hover {
            background: var(--bg-hover, #1e2130);
        }

        .source-table tbody td {
            padding: 0.65rem 1rem;
            color: var(--text-primary, #e0e0e0);
        }

        .source-table tbody td:last-child,
        .source-table tbody td:nth-child(n+2) {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .source-name {
            font-weight: 600;
            color: var(--accent-primary, #22d3ee);
            text-transform: capitalize;
        }

        .benchmark-note {
            font-size: 0.72rem;
            color: var(--text-muted, #666);
            margin-top: 0.5rem;
            font-style: italic;
        }

        /* ── Responsive ─────────────────────────────────────────── */

        @media (max-width: 900px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .chart-grid { grid-template-columns: 1fr; }
            .content-area { padding: 1rem; }
        }

        @media (max-width: 500px) {
            .kpi-grid { grid-template-columns: 1fr; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>
<body>
    <!-- ── Topbar ──────────────────────────────────────────── -->
    <header class="topbar">
        <div class="topbar-brand">Job<span>Hunter</span>3000</div>
    </header>

    <!-- ── Navigation ──────────────────────────────────────── -->
    {% set active = 'analytics' %}
    {% include 'nav.html' %}

    <!-- ── Main Content ────────────────────────────────────── -->
    <main class="content-area">

        <div class="page-header">
            <h1>Analytics</h1>
            <p>Search performance metrics and pipeline intelligence.</p>
        </div>

        <!-- ── KPI Cards ──────────────────────────────────── -->
        <div class="kpi-grid">
            <div class="kpi-card kpi--total">
                <div class="kpi-card__label">Total Jobs Tracked</div>
                <div class="kpi-card__value">{{ total_jobs }}</div>
                <div class="kpi-card__sub">across all sources</div>
            </div>

            <div class="kpi-card kpi--applied">
                <div class="kpi-card__label">Applications Sent</div>
                <div class="kpi-card__value">{{ total_applied }}</div>
                <div class="kpi-card__sub">{{ total_responses }} response{{ 's' if total_responses != 1 }}</div>
            </div>

            <div class="kpi-card kpi--response">
                <div class="kpi-card__label">Response Rate</div>
                <div class="kpi-card__value {% if response_rate > 15 %}kpi-val--green{% elif response_rate > 5 %}kpi-val--amber{% else %}kpi-val--red{% endif %}">
                    {{ response_rate }}%
                </div>
                <div class="kpi-card__sub">industry avg ~3%</div>
            </div>

            <div class="kpi-card kpi--avgscore">
                <div class="kpi-card__label">Avg Match Score</div>
                <div class="kpi-card__value">{{ avg_score }}</div>
                <div class="kpi-card__sub">across scored jobs</div>
            </div>
        </div>

        <!-- ── Charts Row 1: Weekly Apps + Score Distribution ── -->
        <div class="chart-grid">

            <!-- Weekly Applications -->
            <div class="chart-panel">
                <div class="chart-panel__title">Weekly Applications</div>
                {% if weekly_apps | length > 0 %}
                <canvas id="weeklyChart"></canvas>
                {% else %}
                <div style="text-align:center;padding:3rem 1rem;color:var(--text-muted,#666);font-size:0.85rem;">
                    No applications tracked yet. Mark jobs as "Applied" to see trends.
                </div>
                {% endif %}
            </div>

            <!-- Score Distribution -->
            <div class="chart-panel">
                <div class="chart-panel__title">Score Distribution</div>
                <canvas id="scoreChart"></canvas>
            </div>
        </div>

        <!-- ── Charts Row 2: Funnel + Source Effectiveness ──── -->
        <div class="chart-grid">

            <!-- Pipeline Funnel -->
            <div class="chart-panel">
                <div class="chart-panel__title">Pipeline Funnel</div>
                <canvas id="funnelChart"></canvas>
            </div>

            <!-- Source Effectiveness -->
            <div class="chart-panel">
                <div class="chart-panel__title">Source Effectiveness</div>
                {% if source_stats | length > 0 %}
                <table class="source-table">
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th>Jobs</th>
                            <th>Applied</th>
                            <th>Interviews</th>
                            <th>Avg Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for src in source_stats %}
                        <tr>
                            <td><span class="source-name">{{ src.source }}</span></td>
                            <td>{{ src.total }}</td>
                            <td>{{ src.applied }}</td>
                            <td>{{ src.interviews }}</td>
                            <td>{{ src.avg_score or '—' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div style="text-align:center;padding:3rem 1rem;color:var(--text-muted,#666);font-size:0.85rem;">
                    No source data yet. Run a scrape to populate.
                </div>
                {% endif %}
            </div>
        </div>

    </main>

    <!-- ── Chart.js Setup ───────────────────────────────────── -->
    <script>
    (function() {
        // Theme colors
        var CYAN = '#22d3ee';
        var PURPLE = '#a78bfa';
        var GREEN = '#4ade80';
        var AMBER = '#fbbf24';
        var RED = '#f87171';
        var MUTED = '#6b7280';
        var BORDER = '#2a2d3a';
        var TEXT = '#999';

        // Global Chart.js defaults
        Chart.defaults.color = TEXT;
        Chart.defaults.borderColor = BORDER;
        Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
        Chart.defaults.plugins.legend.display = false;

        // ── Weekly Applications Bar Chart ──────────────────────
        {% if weekly_apps | length > 0 %}
        var weeklyCtx = document.getElementById('weeklyChart');
        if (weeklyCtx) {
            new Chart(weeklyCtx, {
                type: 'bar',
                data: {
                    labels: [{% for w in weekly_apps %}'{{ w.week }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                    datasets: [{
                        data: [{% for w in weekly_apps %}{{ w.cnt }}{% if not loop.last %}, {% endif %}{% endfor %}],
                        backgroundColor: PURPLE + '66',
                        borderColor: PURPLE,
                        borderWidth: 1,
                        borderRadius: 4,
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    return ctx.parsed.y + ' application' + (ctx.parsed.y !== 1 ? 's' : '');
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1, color: TEXT },
                            grid: { color: BORDER }
                        },
                        x: {
                            ticks: { color: TEXT, font: { size: 11 } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        {% endif %}

        // ── Score Distribution Bar Chart ───────────────────────
        var scoreCtx = document.getElementById('scoreChart');
        if (scoreCtx) {
            var scoreBuckets = {{ score_dist | tojson }};
            var labels = Object.keys(scoreBuckets);
            var values = Object.values(scoreBuckets);
            var colors = [RED + '88', AMBER + '66', AMBER + '88', CYAN + '88', GREEN + '88'];
            var borderColors = [RED, AMBER, AMBER, CYAN, GREEN];

            new Chart(scoreCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 1,
                        borderRadius: 4,
                        maxBarThickness: 50
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    return ctx.parsed.y + ' job' + (ctx.parsed.y !== 1 ? 's' : '');
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: TEXT },
                            grid: { color: BORDER }
                        },
                        x: {
                            ticks: { color: TEXT },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // ── Pipeline Funnel (Horizontal Bar) ───────────────────
        var funnelCtx = document.getElementById('funnelChart');
        if (funnelCtx) {
            var funnel = {{ funnel | tojson }};
            var funnelLabels = ['New', 'Interested', 'Applied', 'Interviewing', 'Offer', 'Accepted'];
            var funnelKeys = ['new', 'interested', 'applied', 'interviewing', 'offer', 'accepted'];
            var funnelValues = funnelKeys.map(function(k) { return funnel[k] || 0; });
            var funnelColors = [MUTED, CYAN, PURPLE, AMBER, GREEN, GREEN];

            new Chart(funnelCtx, {
                type: 'bar',
                data: {
                    labels: funnelLabels,
                    datasets: [{
                        data: funnelValues,
                        backgroundColor: funnelColors.map(function(c) { return c + '55'; }),
                        borderColor: funnelColors,
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    return ctx.parsed.x + ' job' + (ctx.parsed.x !== 1 ? 's' : '');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { stepSize: 1, color: TEXT },
                            grid: { color: BORDER }
                        },
                        y: {
                            ticks: { color: TEXT, font: { size: 12 } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
    })();
    </script>

    {% include 'chat_widget.html' ignore missing %}
</body>
</html>
