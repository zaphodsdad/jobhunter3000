<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jobs — JobHunter3000</title>
  <style>
  {% include 'base_styles.html' %}
    /* ── Filter Bar ─────────────────────────────────────── */
    .filter-bar {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: #0c0e14;
      border: 1px solid #1a1f2e;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .filter-bar label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
      margin-right: 0.25rem;
    }

    .filter-bar select {
      background: #111318;
      color: #e2e8f0;
      border: 1px solid #2a2f3e;
      border-radius: 6px;
      padding: 0.4rem 0.6rem;
      font-size: 0.85rem;
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s;
    }

    .filter-bar select:hover,
    .filter-bar select:focus {
      border-color: #00e5ff;
    }

    .filter-count {
      margin-left: auto;
      font-size: 0.85rem;
      color: #6b7280;
    }

    .filter-count strong {
      color: #e2e8f0;
    }

    /* ── Jobs Table ─────────────────────────────────────── */
    .jobs-table-wrap {
      overflow-x: auto;
    }

    .jobs-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .jobs-table thead th {
      text-align: left;
      padding: 0.65rem 0.75rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
      border-bottom: 1px solid #1a1f2e;
      white-space: nowrap;
      user-select: none;
    }

    .jobs-table thead th.sortable {
      cursor: pointer;
      transition: color 0.15s;
    }

    .jobs-table thead th.sortable:hover {
      color: #00e5ff;
    }

    .jobs-table thead th.sorted {
      color: #00e5ff;
    }

    .sort-arrow {
      font-size: 0.65rem;
      margin-left: 4px;
      opacity: 0.5;
    }

    .sorted .sort-arrow {
      opacity: 1;
    }

    .jobs-table tbody tr.job-row {
      cursor: pointer;
      transition: background 0.15s;
    }

    .jobs-table tbody tr.job-row:hover {
      background: rgba(0, 229, 255, 0.04);
    }

    .jobs-table tbody tr.job-row td {
      padding: 0.6rem 0.75rem;
      border-bottom: 1px solid #111318;
      vertical-align: middle;
    }

    /* ── Score Badge ────────────────────────────────────── */
    .score-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 2.4rem;
      padding: 0.2rem 0.5rem;
      border-radius: 6px;
      font-weight: 700;
      font-size: 0.85rem;
      text-align: center;
    }

    .score-badge.score-high {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .score-badge.score-good {
      background: rgba(0, 229, 255, 0.12);
      color: #00e5ff;
      border: 1px solid rgba(0, 229, 255, 0.25);
    }

    .score-badge.score-mid {
      background: rgba(245, 158, 11, 0.12);
      color: #fbbf24;
      border: 1px solid rgba(245, 158, 11, 0.25);
    }

    .score-badge.score-low {
      background: rgba(107, 114, 128, 0.12);
      color: #6b7280;
      border: 1px solid rgba(107, 114, 128, 0.25);
    }

    /* ── Status Badge ──────────────────────────────────── */
    .status-badge {
      display: inline-block;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: capitalize;
      white-space: nowrap;
    }

    .status-badge.status-new          { background: rgba(99, 102, 241, 0.15); color: #818cf8; }
    .status-badge.status-interested   { background: rgba(0, 229, 255, 0.12);  color: #00e5ff; }
    .status-badge.status-applied      { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
    .status-badge.status-interviewing { background: rgba(16, 185, 129, 0.15); color: #34d399; }
    .status-badge.status-offer        { background: rgba(168, 85, 247, 0.15); color: #c084fc; }
    .status-badge.status-rejected     { background: rgba(239, 68, 68, 0.12);  color: #f87171; }
    .status-badge.status-archived     { background: rgba(107, 114, 128, 0.12); color: #6b7280; }
    .status-badge.status-accepted     { background: rgba(16, 185, 129, 0.2);  color: #34d399; }

    /* ── Inline Status Select ────────────────────────────── */
    .status-select {
      background: #111318;
      color: #e2e8f0;
      border: 1px solid #2a2f3e;
      border-radius: 6px;
      padding: 0.25rem 0.4rem;
      font-size: 0.78rem;
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s;
    }

    .status-select:hover,
    .status-select:focus {
      border-color: #00e5ff;
    }

    /* ── Column Styling ────────────────────────────────── */
    .job-title-cell {
      font-weight: 600;
      color: #e2e8f0;
    }

    .job-company-cell {
      color: #94a3b8;
    }

    .job-location-cell {
      color: #6b7280;
      font-size: 0.82rem;
    }

    .job-date-cell {
      color: #6b7280;
      font-size: 0.82rem;
      white-space: nowrap;
    }

    /* ── Empty State ───────────────────────────────────── */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6b7280;
    }

    .empty-state h3 {
      color: #94a3b8;
      margin-bottom: 0.5rem;
    }

    /* ═══════════════════════════════════════════════════════
       MODAL OVERLAY
       ═══════════════════════════════════════════════════════ */
    .modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      backdrop-filter: blur(2px);
    }

    .modal-backdrop.open {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 3vh 1rem;
      overflow-y: auto;
    }

    .modal-card {
      background: #1a1d27;
      border: 1px solid #2a2f3e;
      border-radius: 12px;
      width: 100%;
      max-width: 800px;
      max-height: 92vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    /* ── Modal Header ──────────────────────────────────── */
    .modal-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid #2a2f3e;
      flex-shrink: 0;
    }

    .modal-header-info {
      flex: 1;
      min-width: 0;
    }

    .modal-title {
      font-size: 1.15rem;
      font-weight: 700;
      color: #e2e8f0;
      margin: 0 0 4px 0;
    }

    .modal-subtitle {
      font-size: 0.85rem;
      color: #6b7280;
    }

    .modal-subtitle a {
      color: #00e5ff;
      text-decoration: none;
    }

    .modal-subtitle a:hover {
      text-decoration: underline;
    }

    .modal-score {
      flex-shrink: 0;
    }

    .modal-score .score-badge {
      font-size: 1.2rem;
      padding: 0.3rem 0.75rem;
      min-width: 3rem;
    }

    .modal-close {
      flex-shrink: 0;
      background: transparent;
      border: 1px solid #2a2f3e;
      color: #6b7280;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .modal-close:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #f87171;
      color: #f87171;
    }

    /* ── Modal Body ────────────────────────────────────── */
    .modal-body {
      overflow-y: auto;
      padding: 1.25rem 1.5rem;
      flex: 1;
    }

    .modal-section {
      margin-bottom: 1.25rem;
    }

    .modal-section:last-child {
      margin-bottom: 0;
    }

    .modal-section h4 {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #6b7280;
      margin: 0 0 0.5rem 0;
    }

    .modal-section p,
    .modal-section ul {
      margin: 0;
      font-size: 0.85rem;
      color: #cbd5e1;
      line-height: 1.6;
    }

    .modal-section ul {
      padding-left: 1.2rem;
    }

    .modal-section ul li {
      margin-bottom: 0.25rem;
    }

    .pro-item { color: #34d399; }
    .con-item { color: #f87171; }

    .modal-description {
      max-height: 250px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 0.82rem;
      color: #94a3b8;
      padding: 0.75rem;
      background: #111318;
      border-radius: 6px;
      border: 1px solid #1a1f2e;
      line-height: 1.5;
    }

    .modal-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    /* ── Modal Status + Actions Bar ────────────────────── */
    .modal-actions-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 1.25rem;
      flex-wrap: wrap;
    }

    .modal-actions-bar label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #6b7280;
    }

    .modal-actions-bar .status-select {
      font-size: 0.85rem;
      padding: 0.35rem 0.5rem;
    }

    .modal-link {
      margin-left: auto;
    }

    .modal-link a {
      color: #00e5ff;
      text-decoration: none;
      font-size: 0.85rem;
    }

    .modal-link a:hover {
      text-decoration: underline;
    }

    /* ── Notes ──────────────────────────────────────────── */
    .modal-notes textarea {
      width: 100%;
      background: #111318;
      color: #e2e8f0;
      border: 1px solid #2a2f3e;
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      font-size: 0.82rem;
      resize: vertical;
      min-height: 2.5rem;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }

    .modal-notes textarea:focus {
      border-color: #00e5ff;
    }

    .modal-notes-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
      align-items: center;
    }

    .modal-notes-row button {
      background: rgba(0, 229, 255, 0.1);
      color: #00e5ff;
      border: 1px solid rgba(0, 229, 255, 0.25);
      border-radius: 6px;
      padding: 0.35rem 0.75rem;
      font-size: 0.78rem;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.2s;
    }

    .modal-notes-row button:hover {
      background: rgba(0, 229, 255, 0.2);
    }

    .notes-saved {
      font-size: 0.78rem;
      color: #34d399;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .notes-saved.visible {
      opacity: 1;
    }

    /* ── Generation Buttons ────────────────────────────── */
    .gen-tools {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-gen {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 0.5rem 1rem;
      font-size: 0.82rem;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid;
    }

    .btn-gen-resume {
      background: rgba(16, 185, 129, 0.1);
      color: #34d399;
      border-color: rgba(16, 185, 129, 0.3);
    }

    .btn-gen-resume:hover {
      background: rgba(16, 185, 129, 0.2);
    }

    .btn-gen-cover {
      background: rgba(168, 85, 247, 0.1);
      color: #c084fc;
      border-color: rgba(168, 85, 247, 0.3);
    }

    .btn-gen-cover:hover {
      background: rgba(168, 85, 247, 0.2);
    }

    .btn-gen:disabled {
      opacity: 0.5;
      cursor: wait;
    }

    .btn-gen .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ── Generated Output ──────────────────────────────── */
    .gen-output {
      display: none;
      margin-top: 12px;
    }

    .gen-output.visible {
      display: block;
    }

    .gen-output-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .gen-output-header h4 {
      margin: 0;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #6b7280;
    }

    .btn-copy {
      background: rgba(0, 229, 255, 0.1);
      color: #00e5ff;
      border: 1px solid rgba(0, 229, 255, 0.25);
      border-radius: 4px;
      padding: 0.2rem 0.6rem;
      font-size: 0.72rem;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-copy:hover {
      background: rgba(0, 229, 255, 0.2);
    }

    .btn-download-active {
      background: rgba(0, 229, 255, 0.18);
      font-weight: 600;
    }

    .gen-content {
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 0.82rem;
      color: #cbd5e1;
      padding: 0.75rem;
      background: #111318;
      border-radius: 6px;
      border: 1px solid #1a1f2e;
      line-height: 1.6;
      font-family: inherit;
    }

    /* ── Fit Summary ───────────────────────────────────── */
    .fit-summary {
      font-size: 0.9rem;
      color: #e2e8f0;
      font-style: italic;
      padding: 0.5rem 0.75rem;
      background: rgba(0, 229, 255, 0.04);
      border-left: 3px solid #00e5ff;
      border-radius: 0 6px 6px 0;
    }
  </style>
</head>
<body>

  <!-- ── Topbar ──────────────────────────────────────── -->
  <header class="topbar">
    <div class="topbar-brand">Job<span>Hunter</span>3000</div>
    <div class="topbar-right">Intel Report</div>
  </header>

  <!-- ── Navigation ──────────────────────────────────── -->
  {% set active = 'jobs' %}
  {% include 'nav.html' %}

  <!-- ── Content ─────────────────────────────────────── -->
  <main class="content">

    <!-- Filter Bar -->
    <div class="filter-bar">
      <label for="filter-status">Status</label>
      <select id="filter-status" onchange="applyFilters()">
        <option value="">All Statuses</option>
        {% for s in statuses %}
        <option value="{{ s }}" {% if current_status == s %}selected{% endif %}>{{ s | capitalize }}</option>
        {% endfor %}
      </select>

      <label for="filter-source">Source</label>
      <select id="filter-source" onchange="applyFilters()">
        <option value="">All Sources</option>
        {% for src in sources %}
        <option value="{{ src }}" {% if current_source == src %}selected{% endif %}>{{ src | capitalize }}</option>
        {% endfor %}
      </select>

      <label for="filter-min-score">Min Score</label>
      <select id="filter-min-score" onchange="applyFilters()">
        <option value="0" {% if current_min_score == 0 %}selected{% endif %}>All Scores</option>
        <option value="30" {% if current_min_score == 30 %}selected{% endif %}>30+</option>
        <option value="40" {% if current_min_score == 40 %}selected{% endif %}>40+</option>
        <option value="50" {% if current_min_score == 50 %}selected{% endif %}>50+</option>
        <option value="60" {% if current_min_score == 60 %}selected{% endif %}>60+</option>
        <option value="70" {% if current_min_score == 70 %}selected{% endif %}>70+</option>
        <option value="80" {% if current_min_score == 80 %}selected{% endif %}>80+</option>
      </select>

      <label for="filter-sort">Sort</label>
      <select id="filter-sort" onchange="applyFilters()">
        <option value="score_desc" {% if current_sort == 'score' and current_order == 'desc' %}selected{% endif %}>Score (High &rarr; Low)</option>
        <option value="score_asc" {% if current_sort == 'score' and current_order == 'asc' %}selected{% endif %}>Score (Low &rarr; High)</option>
        <option value="created_at_desc" {% if current_sort == 'created_at' and current_order == 'desc' %}selected{% endif %}>Date (Newest)</option>
        <option value="created_at_asc" {% if current_sort == 'created_at' and current_order == 'asc' %}selected{% endif %}>Date (Oldest)</option>
        <option value="company_asc" {% if current_sort == 'company' and current_order == 'asc' %}selected{% endif %}>Company (A &rarr; Z)</option>
        <option value="title_asc" {% if current_sort == 'title' and current_order == 'asc' %}selected{% endif %}>Title (A &rarr; Z)</option>
      </select>

      <span class="filter-count">Showing <strong>{{ jobs | length }}</strong> job{{ 's' if jobs | length != 1 else '' }}</span>
    </div>

    <!-- Jobs Table -->
    {% if jobs | length > 0 %}
    <div class="jobs-table-wrap">
      <table class="jobs-table">
        <thead>
          <tr>
            <th class="sortable {% if current_sort == 'score' %}sorted{% endif %}" onclick="sortBy('score')">
              Score <span class="sort-arrow">{% if current_sort == 'score' %}{{ '&#9650;' if current_order == 'asc' else '&#9660;' }}{% else %}&#9660;{% endif %}</span>
            </th>
            <th class="sortable {% if current_sort == 'title' %}sorted{% endif %}" onclick="sortBy('title')">
              Title <span class="sort-arrow">{% if current_sort == 'title' %}{{ '&#9650;' if current_order == 'asc' else '&#9660;' }}{% else %}&#9650;{% endif %}</span>
            </th>
            <th class="sortable {% if current_sort == 'company' %}sorted{% endif %}" onclick="sortBy('company')">
              Company <span class="sort-arrow">{% if current_sort == 'company' %}{{ '&#9650;' if current_order == 'asc' else '&#9660;' }}{% else %}&#9650;{% endif %}</span>
            </th>
            <th class="sortable {% if current_sort == 'location' %}sorted{% endif %}" onclick="sortBy('location')">
              Location <span class="sort-arrow">{% if current_sort == 'location' %}{{ '&#9650;' if current_order == 'asc' else '&#9660;' }}{% else %}&#9650;{% endif %}</span>
            </th>
            <th class="sortable {% if current_sort == 'status' %}sorted{% endif %}" onclick="sortBy('status')">
              Status <span class="sort-arrow">{% if current_sort == 'status' %}{{ '&#9650;' if current_order == 'asc' else '&#9660;' }}{% else %}&#9650;{% endif %}</span>
            </th>
            <th class="sortable {% if current_sort == 'created_at' %}sorted{% endif %}" onclick="sortBy('created_at')">
              Date <span class="sort-arrow">{% if current_sort == 'created_at' %}{{ '&#9650;' if current_order == 'asc' else '&#9660;' }}{% else %}&#9660;{% endif %}</span>
            </th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for job in jobs %}
          <tr class="job-row" onclick="openModal({{ job.id }}, event)">
            <td>
              {% if job.score is not none %}
              <span class="score-badge {% if job.score >= 80 %}score-high{% elif job.score >= 60 %}score-good{% elif job.score >= 40 %}score-mid{% else %}score-low{% endif %}">
                {{ job.score }}
              </span>
              {% else %}
              <span class="score-badge score-low">&mdash;</span>
              {% endif %}
            </td>
            <td class="job-title-cell">{{ job.title }}</td>
            <td class="job-company-cell">{{ job.company or '—' }}</td>
            <td class="job-location-cell">{{ job.location or '—' }}</td>
            <td>
              <span class="status-badge status-{{ job.status or 'new' }}">{{ (job.status or 'new') | capitalize }}</span>
            </td>
            <td class="job-date-cell">
              {% if job.created_at %}
                {{ job.created_at[:10] }}
              {% else %}
                &mdash;
              {% endif %}
            </td>
            <td onclick="event.stopPropagation()">
              <select class="status-select" data-job-id="{{ job.id }}" onchange="changeStatus(this)">
                <option value="new" {% if (job.status or 'new') == 'new' %}selected{% endif %}>New</option>
                <option value="interested" {% if job.status == 'interested' %}selected{% endif %}>Interested</option>
                <option value="applied" {% if job.status == 'applied' %}selected{% endif %}>Applied</option>
                <option value="interviewing" {% if job.status == 'interviewing' %}selected{% endif %}>Interviewing</option>
                <option value="offer" {% if job.status == 'offer' %}selected{% endif %}>Offer</option>
                <option value="accepted" {% if job.status == 'accepted' %}selected{% endif %}>Accepted</option>
                <option value="rejected" {% if job.status == 'rejected' %}selected{% endif %}>Rejected</option>
                <option value="archived" {% if job.status == 'archived' %}selected{% endif %}>Archived</option>
              </select>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">
      <h3>No jobs found</h3>
      <p>Adjust your filters or run a scrape to populate the database.</p>
    </div>
    {% endif %}

  </main>

  <!-- ═══════════════════════════════════════════════════════
       JOB DETAIL MODAL
       ═══════════════════════════════════════════════════════ -->
  <div class="modal-backdrop" id="modalBackdrop" onclick="closeModal(event)">
    <div class="modal-card" onclick="event.stopPropagation()">

      <!-- Header -->
      <div class="modal-header">
        <div class="modal-score" id="modalScore"></div>
        <div class="modal-header-info">
          <h3 class="modal-title" id="modalTitle">Loading...</h3>
          <div class="modal-subtitle" id="modalSubtitle"></div>
        </div>
        <button class="modal-close" onclick="closeModal()" title="Close (Esc)">&times;</button>
      </div>

      <!-- Body -->
      <div class="modal-body">

        <!-- Status + Link bar -->
        <div class="modal-actions-bar">
          <label>Status</label>
          <select class="status-select" id="modalStatus" onchange="modalChangeStatus()">
            <option value="new">New</option>
            <option value="interested">Interested</option>
            <option value="applied">Applied</option>
            <option value="interviewing">Interviewing</option>
            <option value="offer">Offer</option>
            <option value="accepted">Accepted</option>
            <option value="rejected">Rejected</option>
            <option value="archived">Archived</option>
          </select>
          <div class="modal-link" id="modalLink"></div>
        </div>

        <!-- Fit Summary -->
        <div class="modal-section" id="modalFitSection" style="display:none;">
          <div class="fit-summary" id="modalFit"></div>
        </div>

        <!-- Pros / Cons -->
        <div class="modal-row" id="modalProsConsRow" style="display:none;">
          <div class="modal-section" id="modalProsSection">
            <h4>Pros</h4>
            <ul id="modalPros"></ul>
          </div>
          <div class="modal-section" id="modalConsSection">
            <h4>Cons</h4>
            <ul id="modalCons"></ul>
          </div>
        </div>

        <!-- Description -->
        <div class="modal-section" id="modalDescSection" style="display:none;">
          <h4>Description</h4>
          <div class="modal-description" id="modalDesc"></div>
        </div>

        <!-- Application Tools -->
        <div class="modal-section">
          <h4>Application Tools</h4>
          <div class="gen-tools">
            <button class="btn-gen btn-gen-resume" id="btnGenResume" onclick="generateResume()">
              Generate Resume
            </button>
            <button class="btn-gen btn-gen-cover" id="btnGenCover" onclick="generateCoverLetter()">
              Generate Cover Letter
            </button>
          </div>

          <!-- Resume output -->
          <div class="gen-output" id="resumeOutput">
            <div class="gen-output-header">
              <h4>Generated Resume</h4>
              <div style="display:flex;gap:6px;align-items:center;">
                <span style="font-size:0.7rem;color:#6b7280;">Download:</span>
                <a class="btn-copy btn-download-active" href="#" download style="text-decoration:none;" onclick="downloadDoc('resume','docx')">.docx</a>
                <a class="btn-copy" href="#" download style="text-decoration:none;" onclick="downloadDoc('resume','pdf')">.pdf</a>
                <a class="btn-copy" href="#" download style="text-decoration:none;" onclick="downloadDoc('resume','md')">.md</a>
                <button class="btn-copy" onclick="copyGenerated('resumeContent')">Copy</button>
              </div>
            </div>
            <div class="gen-content" id="resumeContent"></div>
          </div>

          <!-- Cover letter output -->
          <div class="gen-output" id="coverOutput">
            <div class="gen-output-header">
              <h4>Generated Cover Letter</h4>
              <div style="display:flex;gap:6px;align-items:center;">
                <span style="font-size:0.7rem;color:#6b7280;">Download:</span>
                <a class="btn-copy btn-download-active" href="#" download style="text-decoration:none;" onclick="downloadDoc('cover','docx')">.docx</a>
                <a class="btn-copy" href="#" download style="text-decoration:none;" onclick="downloadDoc('cover','pdf')">.pdf</a>
                <a class="btn-copy" href="#" download style="text-decoration:none;" onclick="downloadDoc('cover','md')">.md</a>
                <button class="btn-copy" onclick="copyGenerated('coverContent')">Copy</button>
              </div>
            </div>
            <div class="gen-content" id="coverContent"></div>
          </div>
        </div>

        <!-- Notes -->
        <div class="modal-section modal-notes">
          <h4>Notes</h4>
          <textarea id="modalNotes" placeholder="Add notes about this job..."></textarea>
          <div class="modal-notes-row">
            <button onclick="modalSaveNotes()">Save Notes</button>
            <span class="notes-saved" id="notesSaved">Saved</span>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    /* ── State ──────────────────────────────────────────── */
    var currentSort = {{ current_sort | tojson }};
    var currentOrder = {{ current_order | tojson }};
    var currentJobId = null;

    /* ── Filter Navigation ─────────────────────────────── */
    function applyFilters() {
      var status = document.getElementById('filter-status').value;
      var source = document.getElementById('filter-source').value;
      var minScore = document.getElementById('filter-min-score').value;
      var sortVal = document.getElementById('filter-sort').value;

      var lastUnderscore = sortVal.lastIndexOf('_');
      var sort = sortVal.substring(0, lastUnderscore);
      var order = sortVal.substring(lastUnderscore + 1);

      var params = new URLSearchParams();
      if (status) params.set('status', status);
      if (source) params.set('source', source);
      if (minScore && minScore !== '0') params.set('min_score', minScore);
      if (sort) params.set('sort', sort);
      if (order) params.set('order', order);

      window.location.href = '/jobs' + (params.toString() ? '?' + params.toString() : '');
    }

    /* ── Clickable column sort ─────────────────────────── */
    function sortBy(column) {
      var status = document.getElementById('filter-status').value;
      var source = document.getElementById('filter-source').value;
      var defaults = { score: 'desc', title: 'asc', company: 'asc', location: 'asc', status: 'asc', created_at: 'desc' };
      var order = defaults[column] || 'desc';
      if (currentSort === column) {
        order = currentOrder === 'desc' ? 'asc' : 'desc';
      }
      var params = new URLSearchParams();
      if (status) params.set('status', status);
      if (source) params.set('source', source);
      params.set('sort', column);
      params.set('order', order);
      window.location.href = '/jobs?' + params.toString();
    }

    /* ── Update job count badge ──────────────────────────── */
    function updateJobCount() {
      var count = document.querySelectorAll('tr.job-row').length;
      var el = document.querySelector('.filter-count strong');
      if (el) el.textContent = count;
    }

    /* ── Inline Status Change (table) ──────────────────── */
    function changeStatus(selectEl) {
      var jobId = selectEl.getAttribute('data-job-id');
      var newStatus = selectEl.value;

      fetch('/api/jobs/' + jobId + '/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      })
      .then(function(resp) {
        if (!resp.ok) throw new Error('Status update failed');
        return resp.json();
      })
      .then(function() {
        var row = selectEl.closest('tr.job-row');
        if (row) {
          var badge = row.querySelector('.status-badge');
          if (badge) {
            badge.className = 'status-badge status-' + newStatus;
            badge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
          }
          row.style.transition = 'background 0.3s';
          row.style.background = 'rgba(74, 222, 128, 0.08)';
          setTimeout(function() { row.style.background = ''; }, 800);

          if (newStatus === 'archived') {
            setTimeout(function() {
              row.style.transition = 'opacity 0.5s, max-height 0.5s';
              row.style.opacity = '0';
              setTimeout(function() { row.remove(); updateJobCount(); }, 500);
            }, 800);
          } else if (newStatus === 'rejected') {
            setTimeout(function() {
              row.style.transition = 'opacity 0.5s';
              row.style.opacity = '0.3';
            }, 1000);
          }
        }
      })
      .catch(function() {
        var row = selectEl.closest('tr.job-row');
        if (row) {
          row.style.transition = 'background 0.3s';
          row.style.background = 'rgba(239, 68, 68, 0.1)';
          setTimeout(function() { row.style.background = ''; }, 1500);
        }
      });
    }

    /* ═══════════════════════════════════════════════════════
       MODAL FUNCTIONS
       ═══════════════════════════════════════════════════════ */

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function parseJsonField(val) {
      if (!val) return [];
      if (Array.isArray(val)) return val;
      try { return JSON.parse(val); } catch (e) { return []; }
    }

    function scoreBadgeHtml(score) {
      if (score === null || score === undefined) {
        return '<span class="score-badge score-low">&mdash;</span>';
      }
      var cls = score >= 80 ? 'score-high' : score >= 60 ? 'score-good' : score >= 40 ? 'score-mid' : 'score-low';
      return '<span class="score-badge ' + cls + '">' + score + '</span>';
    }

    function openModal(jobId, event) {
      if (event && (event.target.tagName === 'SELECT' || event.target.tagName === 'OPTION')) return;

      currentJobId = jobId;

      // Reset generation output
      document.getElementById('resumeOutput').classList.remove('visible');
      document.getElementById('coverOutput').classList.remove('visible');
      document.getElementById('resumeContent').textContent = '';
      document.getElementById('coverContent').textContent = '';
      document.getElementById('btnGenResume').disabled = false;
      document.getElementById('btnGenResume').innerHTML = 'Generate Resume';
      document.getElementById('btnGenCover').disabled = false;
      document.getElementById('btnGenCover').innerHTML = 'Generate Cover Letter';

      // Show modal with loading state
      document.getElementById('modalTitle').textContent = 'Loading...';
      document.getElementById('modalSubtitle').textContent = '';
      document.getElementById('modalScore').innerHTML = '';
      document.getElementById('modalFitSection').style.display = 'none';
      document.getElementById('modalProsConsRow').style.display = 'none';
      document.getElementById('modalDescSection').style.display = 'none';
      document.getElementById('modalLink').innerHTML = '';
      document.getElementById('modalNotes').value = '';
      document.getElementById('modalBackdrop').classList.add('open');
      document.body.style.overflow = 'hidden';

      // Fetch full job details
      fetch('/api/jobs/' + jobId)
        .then(function(r) { return r.json(); })
        .then(function(job) {
          populateModal(job);
        })
        .catch(function(err) {
          document.getElementById('modalTitle').textContent = 'Error loading job';
          document.getElementById('modalSubtitle').textContent = err.message;
        });
    }

    function populateModal(job) {
      // Header
      document.getElementById('modalTitle').textContent = job.title || 'Unknown Title';
      var subtitle = escapeHtml(job.company || 'Unknown');
      if (job.location) subtitle += ' &middot; ' + escapeHtml(job.location);
      if (job.salary_text) subtitle += ' &middot; ' + escapeHtml(job.salary_text);
      document.getElementById('modalSubtitle').innerHTML = subtitle;

      // Score
      document.getElementById('modalScore').innerHTML = scoreBadgeHtml(job.score);

      // Status
      document.getElementById('modalStatus').value = job.status || 'new';

      // Link
      if (job.url && !job.url.startsWith('import://')) {
        var src = job.source ? job.source.charAt(0).toUpperCase() + job.source.slice(1) : 'Source';
        document.getElementById('modalLink').innerHTML =
          '<a href="' + escapeHtml(job.url) + '" target="_blank" rel="noopener">View on ' + src + ' &rarr;</a>';
      } else {
        document.getElementById('modalLink').innerHTML = '';
      }

      // Fit Summary
      if (job.fit_summary) {
        document.getElementById('modalFit').textContent = job.fit_summary;
        document.getElementById('modalFitSection').style.display = 'block';
      }

      // Pros / Cons
      var pros = parseJsonField(job.pros);
      var cons = parseJsonField(job.cons);
      if (pros.length || cons.length) {
        var prosHtml = '';
        pros.forEach(function(p) { if (p) prosHtml += '<li class="pro-item">' + escapeHtml(p) + '</li>'; });
        document.getElementById('modalPros').innerHTML = prosHtml || '<li style="color:#6b7280">None</li>';

        var consHtml = '';
        cons.forEach(function(c) { if (c) consHtml += '<li class="con-item">' + escapeHtml(c) + '</li>'; });
        document.getElementById('modalCons').innerHTML = consHtml || '<li style="color:#6b7280">None</li>';

        document.getElementById('modalProsConsRow').style.display = 'grid';
      }

      // Description
      if (job.description) {
        document.getElementById('modalDesc').textContent = job.description;
        document.getElementById('modalDescSection').style.display = 'block';
      }

      // Notes
      document.getElementById('modalNotes').value = job.notes || '';

      // If already generated, show the buttons differently
      if (job.resume_path) {
        document.getElementById('btnGenResume').innerHTML = 'Regenerate Resume';
      }
      if (job.cover_letter_path) {
        document.getElementById('btnGenCover').innerHTML = 'Regenerate Cover Letter';
      }
    }

    function closeModal(event) {
      if (event && event.target !== document.getElementById('modalBackdrop')) return;
      document.getElementById('modalBackdrop').classList.remove('open');
      document.body.style.overflow = '';
      currentJobId = null;
    }

    // ESC key closes modal
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && currentJobId !== null) {
        closeModal();
      }
    });

    /* ── Modal Status Change ───────────────────────────── */
    function modalChangeStatus() {
      if (!currentJobId) return;
      var newStatus = document.getElementById('modalStatus').value;

      fetch('/api/jobs/' + currentJobId + '/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      })
      .then(function(resp) {
        if (!resp.ok) throw new Error('Failed');
        // Update the table row too
        var tableSelect = document.querySelector('.status-select[data-job-id="' + currentJobId + '"]');
        if (tableSelect) {
          tableSelect.value = newStatus;
          var row = tableSelect.closest('tr.job-row');
          var badge = row ? row.querySelector('.status-badge') : null;
          if (badge) {
            badge.className = 'status-badge status-' + newStatus;
            badge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
          }
          // Remove row if archived
          if (newStatus === 'archived' && row) {
            closeModal();
            setTimeout(function() {
              row.style.transition = 'opacity 0.5s';
              row.style.opacity = '0';
              setTimeout(function() { row.remove(); updateJobCount(); }, 500);
            }, 300);
          }
        }
      });
    }

    /* ── Modal Save Notes ──────────────────────────────── */
    function modalSaveNotes() {
      if (!currentJobId) return;
      var notes = document.getElementById('modalNotes').value;

      fetch('/api/jobs/' + currentJobId + '/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes: notes })
      })
      .then(function(resp) {
        if (!resp.ok) throw new Error('Failed');
        var saved = document.getElementById('notesSaved');
        saved.classList.add('visible');
        setTimeout(function() { saved.classList.remove('visible'); }, 2000);
      });
    }

    /* ── Generate Resume ───────────────────────────────── */
    async function generateResume() {
      if (!currentJobId) return;
      var btn = document.getElementById('btnGenResume');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Generating...';

      try {
        var resp = await fetch('/api/jobs/' + currentJobId + '/generate-resume', { method: 'POST' });
        var data = await resp.json();

        if (data.error) throw new Error(data.error);

        document.getElementById('resumeContent').textContent = data.markdown;
        document.getElementById('resumeOutput').classList.add('visible');
        btn.innerHTML = 'Regenerate Resume';
        btn.disabled = false;

        if (window.refreshTopbarCredits) refreshTopbarCredits();
      } catch (err) {
        btn.innerHTML = 'Error: ' + err.message;
        btn.disabled = false;
        setTimeout(function() { btn.innerHTML = 'Generate Resume'; }, 3000);
      }
    }

    /* ── Generate Cover Letter ─────────────────────────── */
    async function generateCoverLetter() {
      if (!currentJobId) return;
      var btn = document.getElementById('btnGenCover');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Generating...';

      try {
        var resp = await fetch('/api/jobs/' + currentJobId + '/generate-cover-letter', { method: 'POST' });
        var data = await resp.json();

        if (data.error) throw new Error(data.error);

        document.getElementById('coverContent').textContent = data.markdown;
        document.getElementById('coverOutput').classList.add('visible');
        btn.innerHTML = 'Regenerate Cover Letter';
        btn.disabled = false;

        if (window.refreshTopbarCredits) refreshTopbarCredits();
      } catch (err) {
        btn.innerHTML = 'Error: ' + err.message;
        btn.disabled = false;
        setTimeout(function() { btn.innerHTML = 'Generate Cover Letter'; }, 3000);
      }
    }

    /* ── Download Generated Doc ────────────────────────── */
    function downloadDoc(docType, format) {
      if (!currentJobId) return;
      event.preventDefault();
      window.open('/api/jobs/' + currentJobId + '/download/' + docType + '?format=' + format, '_blank');
    }

    /* ── Copy Generated Content ────────────────────────── */
    function copyGenerated(elementId) {
      var content = document.getElementById(elementId).textContent;
      navigator.clipboard.writeText(content).then(function() {
        var btn = event.target;
        var orig = btn.textContent;
        btn.textContent = 'Copied!';
        btn.style.color = '#34d399';
        setTimeout(function() {
          btn.textContent = orig;
          btn.style.color = '';
        }, 1500);
      });
    }
  </script>

</body>
</html>
