<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings — JobHunter3000</title>
    <style>
        {% include 'base_styles.html' %}

        .settings-form { max-width: 800px; }

        .card-header {
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 16px; padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        .card-header h2 {
            margin-bottom: 0; font-size: 16px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .card-header h2::before { content: '//'; color: var(--accent-primary); margin-right: 8px; }

        .radio-group { display: flex; gap: 0; margin-bottom: 20px; }
        .radio-group label {
            flex: 1; display: flex; align-items: center; justify-content: center;
            gap: 8px; padding: 10px 16px; font-size: 14px; font-weight: 500;
            color: var(--text-secondary); background: var(--bg-nav);
            border: 1px solid var(--border); cursor: pointer; transition: all 0.15s ease;
        }
        .radio-group label:first-child { border-radius: 6px 0 0 6px; }
        .radio-group label:last-child { border-radius: 0 6px 6px 0; }
        .radio-group label:not(:first-child) { border-left: none; }
        .radio-group input[type="radio"] { display: none; }
        .radio-group input[type="radio"]:checked + label,
        .radio-group label.selected {
            background: var(--accent-primary); color: #0f1117;
            border-color: var(--accent-primary); font-weight: 600;
        }

        .provider-fields { display: none; }
        .provider-fields.active { display: block; }

        .input-with-toggle { position: relative; }
        .input-with-toggle input { padding-right: 48px; }
        .toggle-visibility {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            background: transparent; border: none; color: var(--text-muted);
            cursor: pointer; font-size: 12px; padding: 4px 8px;
            border-radius: 4px; transition: color 0.15s ease;
        }
        .toggle-visibility:hover { color: var(--text-primary); }

        .test-row { display: flex; align-items: center; gap: 12px; margin-top: 8px; }
        .test-result { font-size: 13px; font-weight: 500; opacity: 0; transition: opacity 0.2s ease; }
        .test-result.visible { opacity: 1; }
        .test-result.success { color: var(--score-high); }
        .test-result.error { color: #f87171; }

        .threshold-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        .profile-list { display: flex; flex-direction: column; gap: 8px; }
        .profile-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 14px; background: var(--bg-nav);
            border: 1px solid var(--border); border-radius: 6px; font-size: 13px;
        }
        .profile-item .profile-name { font-weight: 600; color: var(--text-primary); }
        .profile-item .profile-meta { color: var(--text-secondary); font-size: 12px; }
        .profile-item .profile-boards { display: flex; gap: 4px; }
        .board-tag {
            display: inline-block; padding: 2px 8px; font-size: 10px;
            font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
            background: rgba(34, 211, 238, 0.1); color: var(--accent-primary); border-radius: 4px;
        }
        .profile-note { font-size: 12px; color: var(--text-muted); margin-top: 12px; font-style: italic; }

        .btn-save {
            width: 100%; padding: 14px; font-size: 16px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; margin-top: 8px;
        }

        .section-desc { font-size: 13px; color: var(--text-muted); margin-bottom: 16px; }

        .model-select {
            width: 100%; padding: 9px 12px; font-size: 14px; font-family: var(--font-stack);
            color: var(--text-primary); background: var(--bg-nav);
            border: 1px solid var(--border); border-radius: 6px;
        }
        .model-select:focus { outline: none; border-color: var(--accent-primary); }

        .model-status {
            font-size: 12px; color: var(--text-muted); margin-top: 4px;
        }
        .model-status.error { color: #f87171; }
        .model-status.ok { color: #4ade80; }

        .board-checklist {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
        }
        .board-check-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 14px; background: var(--bg-nav);
            border: 1px solid var(--border); border-radius: 6px;
            cursor: pointer; transition: all 0.15s ease; font-size: 14px;
        }
        .board-check-item:hover { border-color: var(--accent-primary); }
        .board-check-item input[type="checkbox"] {
            accent-color: var(--accent-primary); width: 16px; height: 16px;
        }
        .board-check-label { font-weight: 500; color: var(--text-primary); }
        .board-coming { opacity: 0.7; }
        .board-coming:hover { opacity: 1; }
        .board-soon {
            margin-left: auto; font-size: 10px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px;
            color: var(--text-muted); background: rgba(107, 114, 128, 0.15);
            padding: 2px 8px; border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="topbar"><h1>Job<span>Hunter</span>3000</h1></div>

{% set active = 'settings' %}
{% include 'nav.html' %}

<div class="content">
    <form method="POST" action="/settings" class="settings-form">

        <!-- ════════════════════════════════════════════════════
             LLM Provider (Analysis / Resume / Suggestions)
             ════════════════════════════════════════════════════ -->
        <div class="card">
            <div class="card-header"><h2>LLM Provider</h2></div>
            <p class="section-desc">Used for resume analysis, profile synthesis, AI search suggestions, and cover letter generation. Pick the smartest model you can afford.</p>

            <div class="radio-group">
                <input type="radio" name="llm_provider" id="provider-openrouter" value="openrouter"
                       {% if settings.llm_provider == 'openrouter' %}checked{% endif %}>
                <label for="provider-openrouter" id="label-openrouter"
                       class="{% if settings.llm_provider == 'openrouter' %}selected{% endif %}">OpenRouter</label>

                <input type="radio" name="llm_provider" id="provider-ollama" value="ollama"
                       {% if settings.llm_provider == 'ollama' %}checked{% endif %}>
                <label for="provider-ollama" id="label-ollama"
                       class="{% if settings.llm_provider == 'ollama' %}selected{% endif %}">Ollama (Local)</label>
            </div>

            <!-- OpenRouter fields -->
            <div id="openrouter-fields" class="provider-fields {% if settings.llm_provider == 'openrouter' %}active{% endif %}">
                <div class="form-group">
                    <label for="openrouter_api_key">API Key</label>
                    <div class="input-with-toggle">
                        <input type="password" id="openrouter_api_key" name="openrouter_api_key"
                               value="{{ settings.openrouter_api_key }}"
                               placeholder="sk-or-v1-...">
                        <button type="button" class="toggle-visibility" onclick="toggleApiKey()" id="toggle-key-btn">SHOW</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="openrouter_model">Model</label>
                    <select id="openrouter_model" name="openrouter_model" class="model-select">
                        <option value="">-- Select Model --</option>
                    </select>
                </div>
            </div>

            <!-- Ollama fields -->
            <div id="ollama-fields" class="provider-fields {% if settings.llm_provider == 'ollama' %}active{% endif %}">
                <div class="form-group">
                    <label for="ollama_endpoint">Endpoint URL</label>
                    <input type="text" id="ollama_endpoint" name="ollama_endpoint"
                           value="{{ settings.ollama_endpoint }}"
                           placeholder="http://localhost:11434">
                </div>
                <div class="form-group">
                    <label for="ollama_model">Model</label>
                    <select id="ollama_model" name="ollama_model" class="model-select">
                        <option value="">Loading...</option>
                    </select>
                    <div class="model-status" id="ollama-main-status"></div>
                </div>
            </div>

            <div class="test-row">
                <button type="button" class="btn btn-sm" onclick="testLLM()">Test Connection</button>
                <span id="llm-test-result" class="test-result"></span>
            </div>
        </div>

        <!-- ════════════════════════════════════════════════════
             Scoring Model
             ════════════════════════════════════════════════════ -->
        <div class="card">
            <div class="card-header"><h2>Scoring Model</h2></div>
            <p class="section-desc">
                Runs on every job found — use the cheapest model that can output JSON.
                Ollama is free. OpenRouter Haiku is ~$0.001/job.
            </p>

            <div class="radio-group">
                <input type="radio" name="scoring_provider" id="scoring-openrouter" value="openrouter"
                       {% if settings.scoring_provider == 'openrouter' %}checked{% endif %}>
                <label for="scoring-openrouter" id="label-scoring-openrouter"
                       class="{% if settings.scoring_provider == 'openrouter' %}selected{% endif %}">OpenRouter</label>

                <input type="radio" name="scoring_provider" id="scoring-ollama" value="ollama"
                       {% if settings.scoring_provider == 'ollama' %}checked{% endif %}>
                <label for="scoring-ollama" id="label-scoring-ollama"
                       class="{% if settings.scoring_provider == 'ollama' %}selected{% endif %}">Ollama (Free)</label>
            </div>

            <!-- Scoring OpenRouter model -->
            <div id="scoring-openrouter-fields" class="provider-fields {% if settings.scoring_provider == 'openrouter' %}active{% endif %}">
                <div class="form-group">
                    <label for="scoring_model_or">Scoring Model</label>
                    <select id="scoring_model_or" class="model-select" onchange="syncScoringModel()">
                        <option value="">-- Select Model --</option>
                    </select>
                    <div class="model-status">Uses the API key from LLM Provider above.</div>
                </div>
            </div>

            <!-- Scoring Ollama model -->
            <div id="scoring-ollama-fields" class="provider-fields {% if settings.scoring_provider == 'ollama' %}active{% endif %}">
                <div class="form-group">
                    <label for="scoring_model_ollama">Scoring Model</label>
                    <select id="scoring_model_ollama" class="model-select" onchange="syncScoringModel()">
                        <option value="">Loading...</option>
                    </select>
                    <div class="model-status" id="ollama-scoring-status"></div>
                </div>
            </div>

            <!-- Hidden field that actually gets submitted -->
            <input type="hidden" id="scoring_model" name="scoring_model" value="{{ settings.scoring_model }}">
        </div>

        <!-- ════════════════════════════════════════════════════
             Notifications
             ════════════════════════════════════════════════════ -->
        <div class="card">
            <div class="card-header"><h2>Notifications</h2></div>
            <p class="section-desc">Pushover credentials and scoring thresholds for job match alerts.</p>

            <div class="form-group">
                <label for="pushover_user_key">Pushover User Key</label>
                <input type="text" id="pushover_user_key" name="pushover_user_key"
                       value="{{ settings.pushover_user_key }}"
                       placeholder="Your Pushover user key">
            </div>
            <div class="form-group">
                <label for="pushover_api_token">Pushover API Token</label>
                <input type="text" id="pushover_api_token" name="pushover_api_token"
                       value="{{ settings.pushover_api_token }}"
                       placeholder="Your Pushover API token">
            </div>

            <div class="test-row mb-3">
                <button type="button" class="btn btn-sm" onclick="testNotify()">Test Notification</button>
                <span id="notify-test-result" class="test-result"></span>
            </div>

            <div class="threshold-row">
                <div class="form-group">
                    <label for="notify_threshold">Notify Threshold (0-100)</label>
                    <input type="number" id="notify_threshold" name="notify_threshold"
                           value="{{ settings.notify_threshold }}"
                           min="0" max="100" step="1">
                </div>
                <div class="form-group">
                    <label for="priority_threshold">Priority Threshold (0-100)</label>
                    <input type="number" id="priority_threshold" name="priority_threshold"
                           value="{{ settings.priority_threshold }}"
                           min="0" max="100" step="1">
                </div>
            </div>
        </div>

        <!-- ════════════════════════════════════════════════════
             USAJobs API
             ════════════════════════════════════════════════════ -->
        <div class="card">
            <div class="card-header"><h2>USAJobs API</h2></div>
            <p class="section-desc">
                Free API key for federal job searches. Register at
                <a href="https://developer.usajobs.gov/APIRequest/Index" target="_blank" style="color:var(--accent-primary);">developer.usajobs.gov</a>
                — takes 5 minutes.
            </p>
            <div class="form-group">
                <label for="usajobs_api_key">API Key</label>
                <input type="text" id="usajobs_api_key" name="usajobs_api_key"
                       value="{{ settings.usajobs_api_key }}"
                       placeholder="Your USAJobs API key">
            </div>
            <div class="form-group">
                <label for="usajobs_api_email">Registered Email</label>
                <input type="email" id="usajobs_api_email" name="usajobs_api_email"
                       value="{{ settings.usajobs_api_email }}"
                       placeholder="Email used to register for USAJobs API">
            </div>
        </div>

        <!-- ════════════════════════════════════════════════════
             Display
             ════════════════════════════════════════════════════ -->
        <div class="card">
            <div class="card-header"><h2>Display</h2></div>
            <p class="section-desc">Control what shows up on the Intel page. Jobs below the minimum score are hidden (not deleted).</p>

            <div class="form-group">
                <label for="display_min_score">Minimum Score to Display (0 = show all)</label>
                <input type="number" id="display_min_score" name="display_min_score"
                       value="{{ settings.display_min_score }}"
                       min="0" max="100" step="5">
            </div>
        </div>

        <!-- ════════════════════════════════════════════════════
             Job Boards
             ════════════════════════════════════════════════════ -->
        <div class="card">
            <div class="card-header"><h2>Job Boards</h2></div>
            <p class="section-desc">Which boards to scrape. Uncheck to disable. Boards marked "coming soon" aren't built yet.</p>

            <div class="board-checklist" id="boardChecklist">
                {% set all_boards = [
                    ("indeed", "Indeed", true),
                    ("simplyhired", "SimplyHired", true),
                    ("rigzone", "Rigzone", true),
                    ("ziprecruiter", "ZipRecruiter", true),
                    ("dice", "Dice", true),
                    ("remoteok", "RemoteOK", true),
                    ("weworkremotely", "We Work Remotely", true),
                    ("usajobs", "USAJobs (needs API key)", true),
                    ("google_jobs", "Google Jobs", false),
                ] %}
                {% for board_id, board_name, is_built in all_boards %}
                <label class="board-check-item">
                    <input type="checkbox" name="enabled_boards" value="{{ board_id }}"
                           {% if board_id in settings.enabled_boards %}checked{% endif %}>
                    <span class="board-check-label">{{ board_name }}</span>
                    {% if not is_built %}<span class="board-soon">no scraper yet</span>{% endif %}
                </label>
                {% endfor %}
            </div>
        </div>

        <!-- ════════════════════════════════════════════════════
             Search Profiles
             ════════════════════════════════════════════════════ -->
        <div class="card">
            <div class="card-header"><h2>Search Profiles</h2></div>
            <p class="section-desc">Active search configurations used during scraping runs.</p>

            <div class="profile-list">
                {% for profile in settings.search_profiles %}
                <div class="profile-item">
                    <div>
                        <div class="profile-name">{{ profile.name }}</div>
                        <div class="profile-meta">{{ profile.query }} &middot; {{ profile.location }}</div>
                    </div>
                    <div class="profile-boards">
                        {% for board in profile.boards %}
                        <span class="board-tag">{{ board }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            <p class="profile-note">Search profiles can be edited in data/settings.json directly for now.</p>
        </div>

        <!-- ════════════════════════════════════════════════════
             Filters
             ════════════════════════════════════════════════════ -->
        <div class="card">
            <div class="card-header"><h2>Filters</h2></div>
            <p class="section-desc">Keywords and age limits to automatically exclude irrelevant postings.</p>

            <div class="form-group">
                <label for="exclude_keywords">Exclude Keywords (one per line)</label>
                <textarea id="exclude_keywords" name="exclude_keywords"
                          rows="5"
                          placeholder="security clearance required&#10;commission only&#10;CDL required">{{ settings.exclude_keywords | join('\n') }}</textarea>
            </div>
            <div class="form-group">
                <label for="max_days_old">Max Posting Age (days)</label>
                <input type="number" id="max_days_old" name="max_days_old"
                       value="{{ settings.max_days_old }}"
                       min="1" max="90" step="1">
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-save">Save Settings</button>
    </form>
</div>

<div class="toast-container" id="toast-container"></div>

<script>
    // ── Current saved values ──────────────────────────────
    var SAVED_OR_MODEL = {{ settings.openrouter_model | tojson }};
    var SAVED_OLLAMA_MODEL = {{ settings.ollama_model | tojson }};
    var SAVED_SCORING_MODEL = {{ settings.scoring_model | tojson }};

    // ── OpenRouter model catalog (curated) ────────────────
    var OR_MODELS = [
        { group: 'Anthropic', models: [
            { id: 'anthropic/claude-opus-4', name: 'Claude Opus 4', tier: 'premium' },
            { id: 'anthropic/claude-sonnet-4', name: 'Claude Sonnet 4', tier: 'smart' },
            { id: 'anthropic/claude-haiku-4-5-20251001', name: 'Claude Haiku 4.5', tier: 'cheap' },
        ]},
        { group: 'Meta', models: [
            { id: 'meta-llama/llama-3.3-70b-instruct', name: 'Llama 3.3 70B', tier: 'smart' },
            { id: 'meta-llama/llama-3.1-8b-instruct', name: 'Llama 3.1 8B', tier: 'cheap' },
        ]},
        { group: 'Google', models: [
            { id: 'google/gemini-2.5-pro-preview', name: 'Gemini 2.5 Pro', tier: 'premium' },
            { id: 'google/gemini-2.0-flash-001', name: 'Gemini 2.0 Flash', tier: 'cheap' },
        ]},
        { group: 'DeepSeek', models: [
            { id: 'deepseek/deepseek-r1', name: 'DeepSeek R1', tier: 'smart' },
            { id: 'deepseek/deepseek-chat', name: 'DeepSeek Chat V3', tier: 'cheap' },
        ]},
        { group: 'OpenAI', models: [
            { id: 'openai/gpt-4o', name: 'GPT-4o', tier: 'smart' },
            { id: 'openai/gpt-4o-mini', name: 'GPT-4o Mini', tier: 'cheap' },
        ]},
        { group: 'Qwen', models: [
            { id: 'qwen/qwen-2.5-72b-instruct', name: 'Qwen 2.5 72B', tier: 'smart' },
            { id: 'qwen/qwen-2.5-coder-32b-instruct', name: 'Qwen 2.5 Coder 32B', tier: 'cheap' },
        ]},
    ];

    function populateORDropdown(selectId, savedValue) {
        var sel = document.getElementById(selectId);
        if (!sel) return;
        sel.innerHTML = '<option value="">-- Select Model --</option>';
        OR_MODELS.forEach(function(group) {
            var optgroup = document.createElement('optgroup');
            optgroup.label = group.group;
            group.models.forEach(function(m) {
                var opt = document.createElement('option');
                opt.value = m.id;
                var tierLabel = m.tier === 'premium' ? ' [Premium]' : m.tier === 'cheap' ? ' [Cheap]' : '';
                opt.textContent = m.name + tierLabel;
                if (m.id === savedValue) opt.selected = true;
                optgroup.appendChild(opt);
            });
            sel.appendChild(optgroup);
        });
        // If saved value not in catalog, add it as custom option
        if (savedValue && !sel.value) {
            var opt = document.createElement('option');
            opt.value = savedValue;
            opt.textContent = savedValue + ' (custom)';
            opt.selected = true;
            sel.insertBefore(opt, sel.children[1]);
        }
    }

    // ── Ollama model fetch ────────────────────────────────
    var ollamaModelsCache = null;

    function fetchOllamaModels(callback) {
        if (ollamaModelsCache) { callback(ollamaModelsCache); return; }
        fetch('/api/ollama/models').then(function(r) { return r.json(); }).then(function(data) {
            if (data.ok) {
                ollamaModelsCache = data.models;
                callback(data.models);
            } else {
                callback(null, data.error);
            }
        }).catch(function(err) { callback(null, err.message); });
    }

    function populateOllamaDropdown(selectId, statusId, savedValue) {
        var sel = document.getElementById(selectId);
        var status = statusId ? document.getElementById(statusId) : null;
        if (!sel) return;

        fetchOllamaModels(function(models, error) {
            sel.innerHTML = '';
            if (error || !models) {
                sel.innerHTML = '<option value="">-- Ollama offline --</option>';
                if (savedValue) {
                    var opt = document.createElement('option');
                    opt.value = savedValue;
                    opt.textContent = savedValue + ' (saved, offline)';
                    opt.selected = true;
                    sel.appendChild(opt);
                }
                if (status) {
                    status.textContent = 'Cannot reach Ollama: ' + (error || 'unknown error');
                    status.className = 'model-status error';
                }
                return;
            }

            models.forEach(function(m) {
                var opt = document.createElement('option');
                opt.value = m.name;
                opt.textContent = m.name + ' (' + m.size_gb + ' GB)';
                if (m.name === savedValue) opt.selected = true;
                sel.appendChild(opt);
            });

            if (savedValue && !sel.value) {
                var opt = document.createElement('option');
                opt.value = savedValue;
                opt.textContent = savedValue + ' (saved, not found)';
                opt.selected = true;
                sel.insertBefore(opt, sel.firstChild);
            }

            if (status) {
                status.textContent = models.length + ' models available';
                status.className = 'model-status ok';
            }
        });
    }

    // ── Provider toggle (main LLM) ───────────────────────
    var mainProviders = ['openrouter', 'ollama'];

    function updateMainProvider() {
        var selected = document.querySelector('input[name="llm_provider"]:checked').value;
        mainProviders.forEach(function(p) {
            var fields = document.getElementById(p + '-fields');
            var label = document.getElementById('label-' + p);
            if (p === selected) {
                if (fields) fields.classList.add('active');
                if (label) label.classList.add('selected');
            } else {
                if (fields) fields.classList.remove('active');
                if (label) label.classList.remove('selected');
            }
        });
    }

    mainProviders.forEach(function(p) {
        var radio = document.getElementById('provider-' + p);
        if (radio) radio.addEventListener('change', updateMainProvider);
    });

    // ── Provider toggle (scoring) ─────────────────────────
    var scoringProviders = ['openrouter', 'ollama'];

    function updateScoringProvider() {
        var selected = document.querySelector('input[name="scoring_provider"]:checked').value;
        scoringProviders.forEach(function(p) {
            var fields = document.getElementById('scoring-' + p + '-fields');
            var label = document.getElementById('label-scoring-' + p);
            if (p === selected) {
                if (fields) fields.classList.add('active');
                if (label) label.classList.add('selected');
            } else {
                if (fields) fields.classList.remove('active');
                if (label) label.classList.remove('selected');
            }
        });
        syncScoringModel();
    }

    scoringProviders.forEach(function(p) {
        var radio = document.getElementById('scoring-' + p);
        if (radio) radio.addEventListener('change', updateScoringProvider);
    });

    function syncScoringModel() {
        var provider = document.querySelector('input[name="scoring_provider"]:checked').value;
        var hidden = document.getElementById('scoring_model');
        if (provider === 'openrouter') {
            hidden.value = document.getElementById('scoring_model_or').value;
        } else {
            hidden.value = document.getElementById('scoring_model_ollama').value;
        }
    }

    // ── API key show/hide ─────────────────────────────────
    function toggleApiKey() {
        var input = document.getElementById('openrouter_api_key');
        var btn = document.getElementById('toggle-key-btn');
        if (input.type === 'password') { input.type = 'text'; btn.textContent = 'HIDE'; }
        else { input.type = 'password'; btn.textContent = 'SHOW'; }
    }

    // ── Test LLM ──────────────────────────────────────────
    async function testLLM() {
        var result = document.getElementById('llm-test-result');
        result.textContent = 'Testing...';
        result.className = 'test-result visible';
        try {
            var resp = await fetch('/api/test-llm', { method: 'POST' });
            var data = await resp.json();
            if (data.ok) {
                result.textContent = 'Connected! Response: ' + (data.response || '').substring(0, 60);
                result.className = 'test-result visible success';
            } else {
                result.textContent = data.error || 'Connection failed';
                result.className = 'test-result visible error';
            }
        } catch (err) {
            result.textContent = 'Request failed: ' + err.message;
            result.className = 'test-result visible error';
        }
    }

    // ── Test notification ─────────────────────────────────
    async function testNotify() {
        var result = document.getElementById('notify-test-result');
        result.textContent = 'Sending...';
        result.className = 'test-result visible';
        try {
            var resp = await fetch('/api/test-notify', { method: 'POST' });
            var data = await resp.json();
            if (data.ok) {
                result.textContent = 'Sent!';
                result.className = 'test-result visible success';
            } else {
                result.textContent = data.error || 'Send failed';
                result.className = 'test-result visible error';
            }
        } catch (err) {
            result.textContent = 'Request failed: ' + err.message;
            result.className = 'test-result visible error';
        }
    }

    // ── Toast ─────────────────────────────────────────────
    function showToast(message, type) {
        var container = document.getElementById('toast-container');
        var toast = document.createElement('div');
        toast.className = 'toast toast-' + (type || 'success');
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(function() {
            toast.style.animation = 'toast-out 0.3s ease forwards';
            setTimeout(function() { toast.remove(); }, 300);
        }, 4000);
    }

    {% if saved %}
    document.addEventListener('DOMContentLoaded', function() {
        showToast('Settings saved successfully', 'success');
    });
    {% endif %}

    // ── Initialize dropdowns on page load ─────────────────
    document.addEventListener('DOMContentLoaded', function() {
        // OpenRouter dropdowns
        populateORDropdown('openrouter_model', SAVED_OR_MODEL);
        populateORDropdown('scoring_model_or', SAVED_SCORING_MODEL);

        // Ollama dropdowns
        populateOllamaDropdown('ollama_model', 'ollama-main-status', SAVED_OLLAMA_MODEL);
        populateOllamaDropdown('scoring_model_ollama', 'ollama-scoring-status', SAVED_SCORING_MODEL);

        // Sync scoring hidden field on dropdown changes
        document.getElementById('scoring_model_or').addEventListener('change', syncScoringModel);
        document.getElementById('scoring_model_ollama').addEventListener('change', syncScoringModel);
    });
</script>

</body>
</html>
